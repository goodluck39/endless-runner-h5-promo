<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>无尽跑酷 - 升级版</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #87ceeb;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #87ceeb;
    }
    #restartBtn {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      background: #ff5722;
      color: #fff;
      font-size: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #restartBtn:hover {
      background: #e64a19;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <button id="restartBtn">重新开始</button>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const restartBtn = document.getElementById("restartBtn");

    // 游戏变量
    let player, obstacles, coins, gameSpeed, score, highScore, isGameOver;

    // 初始化
    function init() {
      player = {
        x: 100,
        y: canvas.height - 150,
        width: 50,
        height: 50,
        dy: 0,
        gravity: 1,
        jumpPower: -20,
        grounded: false
      };
      obstacles = [];
      coins = [];
      gameSpeed = 6;
      score = 0;
      highScore = localStorage.getItem("highScore") || 0;
      isGameOver = false;
      restartBtn.style.display = "none";
    }

    // 控制跳跃
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" && player.grounded && !isGameOver) {
        player.dy = player.jumpPower;
        player.grounded = false;
      }
    });

    // 生成障碍物
    function spawnObstacle() {
      if (Math.random() < 0.03) {
        obstacles.push({
          x: canvas.width,
          y: canvas.height - 100,
          width: 50,
          height: 50
        });
      }
    }

    // 生成金币
    function spawnCoin() {
      if (Math.random() < 0.05) {
        coins.push({
          x: canvas.width,
          y: canvas.height - 150 - Math.random() * 100,
          radius: 15
        });
      }
    }

    // 更新
    function update() {
      if (isGameOver) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 背景
      ctx.fillStyle = "#87ceeb";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#228B22";
      ctx.fillRect(0, canvas.height - 80, canvas.width, 80);

      // 玩家
      player.y += player.dy;
      player.dy += player.gravity;
      if (player.y + player.height >= canvas.height - 80) {
        player.y = canvas.height - 80 - player.height;
        player.dy = 0;
        player.grounded = true;
      }
      ctx.fillStyle = "red";
      ctx.fillRect(player.x, player.y, player.width, player.height);

      // 障碍物
      spawnObstacle();
      ctx.fillStyle = "black";
      for (let i = obstacles.length - 1; i >= 0; i--) {
        let obs = obstacles[i];
        obs.x -= gameSpeed;
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);

        // 碰撞检测
        if (
          player.x < obs.x + obs.width &&
          player.x + player.width > obs.x &&
          player.y < obs.y + obs.height &&
          player.y + player.height > obs.y
        ) {
          gameOver();
        }

        if (obs.x + obs.width < 0) {
          obstacles.splice(i, 1);
        }
      }

      // 金币
      spawnCoin();
      ctx.fillStyle = "gold";
      for (let i = coins.length - 1; i >= 0; i--) {
        let c = coins[i];
        c.x -= gameSpeed;
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
        ctx.fill();

        if (
          player.x < c.x + c.radius &&
          player.x + player.width > c.x - c.radius &&
          player.y < c.y + c.radius &&
          player.y + player.height > c.y - c.radius
        ) {
          score += 10;
          coins.splice(i, 1);
        }

        if (c.x + c.radius < 0) {
          coins.splice(i, 1);
        }
      }

      // 得分 & 难度提升
      score++;
      if (score % 500 === 0) gameSpeed += 0.5;

      // 分数显示
      ctx.fillStyle = "black";
      ctx.font = "24px Arial";
      ctx.fillText(`分数: ${score}`, 20, 40);
      ctx.fillText(`最高分: ${highScore}`, 20, 70);

      requestAnimationFrame(update);
    }

    // 游戏结束
    function gameOver() {
      isGameOver = true;
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
      }
      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.font = "48px Arial";
      ctx.fillText("游戏结束!", canvas.width / 2 - 100, canvas.height / 2 - 50);
      ctx.font = "32px Arial";
      ctx.fillText(`本次得分: ${score}`, canvas.width / 2 - 80, canvas.height / 2);
      ctx.fillText(`最高分: ${highScore}`, canvas.width / 2 - 80, canvas.height / 2 + 40);
      restartBtn.style.display = "block";
    }

    restartBtn.addEventListener("click", () => {
      init();
      update();
    });

    // 启动
    init();
    update();
  </script>
</body>
</html>
